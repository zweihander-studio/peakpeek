<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PeakPeek AR</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --green: #1e4d30; --green-l: #2d6a4f;
  --white: #ffffff; --ink: #1a1916;
  --f: 'Plus Jakarta Sans', system-ui, sans-serif;
}
html, body { width:100%; height:100%; overflow:hidden; background:#000; font-family:var(--f); -webkit-font-smoothing:antialiased; user-select:none; -webkit-user-select:none; }
#video { position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }
#topbar { position:fixed; top:0; left:0; right:0; padding:max(env(safe-area-inset-top),48px) 20px 14px; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(180deg,rgba(0,0,0,0.5) 0%,transparent 100%); z-index:10; }
#wordmark { font-size:20px; font-weight:800; letter-spacing:-0.04em; color:white; text-shadow:0 1px 8px rgba(0,0,0,0.3); }
#wordmark span { color:rgba(255,255,255,0.45); }
#compass-wrap { display:flex; align-items:center; gap:10px; }
#heading-display { font-size:13px; font-weight:700; color:white; letter-spacing:0.02em; }
#compass-dial { width:38px; height:38px; border-radius:50%; background:rgba(255,255,255,0.88); backdrop-filter:blur(12px); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:800; color:#c0392b; box-shadow:0 2px 10px rgba(0,0,0,0.15); }
#tray { position:fixed; bottom:0; left:0; right:0; padding:16px 20px max(env(safe-area-inset-bottom),20px); background:linear-gradient(0deg,rgba(0,0,0,0.6) 0%,transparent 100%); z-index:10; display:flex; align-items:flex-end; }
.tray-stat { display:flex; flex-direction:column; gap:2px; flex:1; }
.tray-lbl { font-size:8px; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:rgba(255,255,255,0.5); }
.tray-val { font-size:16px; font-weight:700; letter-spacing:-0.02em; color:white; }
.tray-div { width:1px; height:32px; background:rgba(255,255,255,0.2); margin:0 16px 4px; }
#peaks-pill { background:var(--green); color:white; border-radius:100px; padding:7px 16px; font-size:10px; font-weight:700; letter-spacing:0.04em; margin-bottom:3px; white-space:nowrap; box-shadow:0 2px 12px rgba(30,77,48,0.5); }
.ar-label { position:fixed; display:flex; flex-direction:column; align-items:center; z-index:5; pointer-events:auto; transform:translateX(-50%); cursor:pointer; }
.ar-card { background:rgba(255,255,255,0.90); backdrop-filter:blur(20px) saturate(1.5); -webkit-backdrop-filter:blur(20px) saturate(1.5); border-radius:10px; padding:6px 12px 7px; box-shadow:0 2px 16px rgba(0,0,0,0.18); white-space:nowrap; -webkit-tap-highlight-color:transparent; }
.ar-name { font-size:11px; font-weight:700; color:var(--ink); }
.ar-info { font-size:9px; font-weight:500; color:var(--green-l); margin-top:1px; }
.ar-stem { width:1px; height:16px; background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent); }
.ar-dot  { width:6px; height:6px; border-radius:50%; background:white; box-shadow:0 0 0 2px rgba(255,255,255,0.35); }
#status { position:fixed; top:calc(max(env(safe-area-inset-top),48px) + 52px); left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.55); backdrop-filter:blur(10px); color:rgba(255,255,255,0.9); border-radius:100px; padding:7px 16px; font-size:11px; font-weight:600; z-index:20; transition:opacity 0.4s; white-space:nowrap; pointer-events:none; }
#status.hide { opacity:0; }
#no-peaks { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; z-index:5; pointer-events:none; opacity:0; transition:opacity 0.4s; }
#no-peaks.show { opacity:1; }
#no-peaks p { font-size:14px; color:rgba(255,255,255,0.75); font-weight:500; line-height:1.7; text-shadow:0 1px 6px rgba(0,0,0,0.5); }
#detail-panel { position:fixed; bottom:-100%; left:0; right:0; background:white; border-radius:24px 24px 0 0; padding:20px 22px 40px; z-index:50; box-shadow:0 -8px 40px rgba(0,0,0,0.25); transition:bottom 0.38s cubic-bezier(0.32,0.72,0,1); max-height:70vh; overflow-y:auto; }
#detail-panel.open { bottom:0; }
.dp-handle { width:36px; height:4px; background:#e0ddd8; border-radius:2px; margin:0 auto 16px; }
.dp-kicker { font-size:10px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--green-l); margin-bottom:4px; }
.dp-title  { font-size:32px; font-weight:800; letter-spacing:-0.04em; color:var(--ink); line-height:1; margin-bottom:4px; }
.dp-alt    { font-size:12px; color:#8a8780; font-style:italic; margin-bottom:16px; }
.dp-chips  { display:flex; gap:8px; margin-bottom:14px; }
.dp-chip   { flex:1; background:#f8f7f4; border:1px solid #ebe8e2; border-radius:10px; padding:9px 5px; text-align:center; }
.dp-chip-v { font-size:15px; font-weight:700; color:var(--ink); }
.dp-chip-l { font-size:8px; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:#8a8780; margin-top:3px; }
.dp-btns   { display:flex; gap:10px; }
.dp-btn    { flex:1; padding:14px; border-radius:100px; font-family:var(--f); font-size:13px; font-weight:700; border:none; cursor:pointer; -webkit-tap-highlight-color:transparent; }
.dp-btn.solid   { background:var(--green); color:white; }
.dp-btn.outline { background:transparent; border:1.5px solid #d4d0c8; color:var(--ink); }
#dp-close { position:absolute; top:16px; right:18px; width:30px; height:30px; border-radius:50%; background:#f0ede8; border:none; cursor:pointer; font-size:14px; color:#8a8780; font-family:var(--f); }

/* OVERLAYS */
.overlay { position:fixed; inset:0; background:linear-gradient(160deg,#0d2b1a 0%,#1e4d30 100%); z-index:100; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px 32px; text-align:center; transition:opacity 0.4s; }
.overlay.hidden { opacity:0; pointer-events:none; }
.ov-logo { font-size:26px; font-weight:800; letter-spacing:-0.04em; color:white; margin-bottom:4px; }
.ov-logo span { color:rgba(255,255,255,0.35); }
.ov-tagline { font-size:12px; color:rgba(255,255,255,0.4); margin-bottom:44px; letter-spacing:0.04em; }
.ov-icon  { font-size:52px; margin-bottom:20px; }
.ov-title { font-size:24px; font-weight:800; letter-spacing:-0.03em; color:white; margin-bottom:12px; line-height:1.1; }
.ov-body  { font-size:14px; color:rgba(255,255,255,0.5); line-height:1.65; margin-bottom:32px; max-width:280px; }
.perm-steps { display:flex; flex-direction:column; gap:10px; margin-bottom:28px; width:100%; max-width:280px; }
.perm-step  { display:flex; align-items:center; gap:12px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:12px 14px; }
.perm-icon  { font-size:20px; flex-shrink:0; }
.perm-text  { text-align:left; flex:1; }
.perm-name  { font-size:12px; font-weight:700; color:white; }
.perm-desc  { font-size:10px; color:rgba(255,255,255,0.45); margin-top:2px; }
.perm-check { font-size:16px; flex-shrink:0; opacity:0; transition:opacity 0.3s; }
.perm-check.done { opacity:1; }
.ov-btn { width:100%; max-width:280px; padding:16px; background:white; color:var(--green); border:none; border-radius:100px; font-family:var(--f); font-size:15px; font-weight:800; cursor:pointer; box-shadow:0 8px 24px rgba(0,0,0,0.3); transition:transform 0.15s,opacity 0.15s; -webkit-tap-highlight-color:transparent; margin-bottom:12px; }
.ov-btn:active { transform:scale(0.97); opacity:0.9; }
.ov-btn:disabled { opacity:0.5; }
.ov-note { font-size:11px; color:rgba(255,255,255,0.25); max-width:260px; line-height:1.5; }
#cal-hint { position:fixed; bottom:120px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); backdrop-filter:blur(10px); border-radius:12px; padding:10px 16px; font-size:11px; font-weight:600; color:rgba(255,255,255,0.85); z-index:20; text-align:center; max-width:220px; line-height:1.5; opacity:0; transition:opacity 0.4s; pointer-events:none; }
#cal-hint.show { opacity:1; }
</style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>

<div id="topbar">
  <div id="wordmark">Peak<span>Peek</span></div>
  <div id="compass-wrap">
    <div id="heading-display">--¬∞</div>
    <div id="compass-dial">N</div>
  </div>
</div>

<div id="status" class="hide">üì° Getting location...</div>

<div id="tray">
  <div class="tray-stat"><div class="tray-lbl">Altitude</div><div class="tray-val" id="tray-alt">-- m</div></div>
  <div class="tray-div"></div>
  <div class="tray-stat"><div class="tray-lbl">Heading</div><div class="tray-val" id="tray-heading">--¬∞</div></div>
  <div class="tray-div"></div>
  <div class="tray-stat"><div class="tray-lbl">Peaks</div><div class="tray-val" id="tray-peaks">--</div></div>
  <div id="peaks-pill">Loading...</div>
</div>

<div id="ar-container"></div>
<div id="no-peaks"><p>‚õ∞Ô∏è<br>Point toward<br>the horizon<br>to find peaks</p></div>
<div id="cal-hint">üß≠ Move phone in a figure-8 to calibrate compass</div>

<div id="detail-panel">
  <div class="dp-handle"></div>
  <button id="dp-close" onclick="closeDetail()">‚úï</button>
  <div class="dp-kicker" id="dp-kicker"></div>
  <div class="dp-title"  id="dp-title">‚Äî</div>
  <div class="dp-alt"    id="dp-alt">‚Äî</div>
  <div class="dp-chips">
    <div class="dp-chip"><div class="dp-chip-v" id="dp-elev">‚Äî</div><div class="dp-chip-l">Elevation</div></div>
    <div class="dp-chip"><div class="dp-chip-v" id="dp-dist">‚Äî</div><div class="dp-chip-l">Distance</div></div>
    <div class="dp-chip"><div class="dp-chip-v" id="dp-bear">‚Äî</div><div class="dp-chip-l">Bearing</div></div>
  </div>
  <div class="dp-btns">
    <button class="dp-btn solid"   id="dp-save">Save Peak</button>
    <button class="dp-btn outline">View Routes ‚Üí</button>
  </div>
</div>

<!-- SPLASH -->
<div class="overlay" id="step-splash">
  <div class="ov-logo">Peak<span>Peek</span></div>
  <div class="ov-tagline">Know every mountain by name</div>
  <div class="ov-icon">‚õ∞Ô∏è</div>
  <div class="ov-title">Real AR.<br>Real mountains.</div>
  <div class="ov-body">Point your phone at any mountain and instantly know its name, elevation and distance.</div>
  <button class="ov-btn" id="btn-start">Get Started ‚Üí</button>
  <div class="ov-note">Works best outdoors with mountains visible on the horizon</div>
</div>

<!-- PERMISSIONS -->
<div class="overlay hidden" id="step-perms">
  <div class="ov-logo">Peak<span>Peek</span></div>
  <div class="ov-tagline">One-time setup</div>
  <div class="ov-icon">üîê</div>
  <div class="ov-title">3 quick<br>permissions</div>
  <div class="ov-body">Tap below ‚Äî iOS will ask you to confirm each one.</div>
  <div class="perm-steps">
    <div class="perm-step">
      <div class="perm-icon">üì∑</div>
      <div class="perm-text"><div class="perm-name">Camera</div><div class="perm-desc">To see the world through your lens</div></div>
      <div class="perm-check" id="pc-camera">‚úÖ</div>
    </div>
    <div class="perm-step">
      <div class="perm-icon">üìç</div>
      <div class="perm-text"><div class="perm-name">Location</div><div class="perm-desc">To find peaks near you</div></div>
      <div class="perm-check" id="pc-location">‚úÖ</div>
    </div>
    <div class="perm-step">
      <div class="perm-icon">üß≠</div>
      <div class="perm-text"><div class="perm-name">Motion & Compass</div><div class="perm-desc">To know which direction you're pointing</div></div>
      <div class="perm-check" id="pc-motion">‚úÖ</div>
    </div>
  </div>
  <button class="ov-btn" id="btn-perms">Allow & Start ‚Üí</button>
  <div class="ov-note">All data stays on your device. Nothing uploaded.</div>
</div>

<!-- LOADING -->
<div class="overlay hidden" id="step-loading">
  <div class="ov-logo">Peak<span>Peek</span></div>
  <div class="ov-tagline">Almost there...</div>
  <div class="ov-icon" id="loading-icon">üó∫Ô∏è</div>
  <div class="ov-title" id="loading-title">Finding your<br>location...</div>
  <div class="ov-body" id="loading-body">Locking onto GPS and searching for peaks near you.</div>
</div>

<script>
let userLat=null, userLng=null, userAlt=0;
let heading=0, tiltX=0;
let peaks=[], savedPeaks=new Set();
const H_FOV=60, V_FOV=45;

// ‚îÄ‚îÄ Button listeners attached after DOM ready ‚îÄ‚îÄ
document.getElementById('btn-start').addEventListener('click', function() {
  document.getElementById('step-splash').classList.add('hidden');
  document.getElementById('step-perms').classList.remove('hidden');
});

document.getElementById('btn-perms').addEventListener('click', async function() {
  const btn = this;
  btn.disabled = true;
  btn.textContent = 'Requesting...';

  // STEP 1: Camera
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    document.getElementById('video').srcObject = stream;
    await document.getElementById('video').play();
    document.getElementById('pc-camera').classList.add('done');
  } catch(e) {
    alert('Camera access denied. Please allow camera in Safari Settings and reload.');
    btn.disabled = false; btn.textContent = 'Allow & Start ‚Üí';
    return;
  }

  // STEP 2: Motion/Compass ‚Äî iOS 13+ MUST be requested here inside user gesture
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const r = await DeviceOrientationEvent.requestPermission();
      if (r === 'granted') {
        document.getElementById('pc-motion').classList.add('done');
        window.addEventListener('deviceorientation', handleOrientation, true);
      }
    } catch(e) { /* compass won't work but app continues */ }
  } else {
    // Android or older iOS ‚Äî no prompt needed
    window.addEventListener('deviceorientation', handleOrientation, true);
    document.getElementById('pc-motion').classList.add('done');
  }

  // STEP 3: Show loading, start GPS
  document.getElementById('step-perms').classList.add('hidden');
  document.getElementById('step-loading').classList.remove('hidden');

  startGPS();
  startRenderLoop();

  setTimeout(() => {
    const h = document.getElementById('cal-hint');
    h.classList.add('show');
    setTimeout(() => h.classList.remove('show'), 4000);
  }, 6000);
});

// ‚îÄ‚îÄ GPS ‚îÄ‚îÄ
function startGPS() {
  if (!navigator.geolocation) {
    setLoading('‚ö†Ô∏è','GPS unavailable','Your device does not support location.');
    setTimeout(hideOverlays, 2000);
    return;
  }
  navigator.geolocation.watchPosition(pos => {
    const first = userLat === null;
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
    userAlt = pos.coords.altitude || 0;
    document.getElementById('pc-location').classList.add('done');
    document.getElementById('tray-alt').textContent = userAlt > 0 ? Math.round(userAlt)+' m' : '-- m';
    if (first) { setLoading('‚õ∞Ô∏è','Loading peaks...','Found you! Searching for mountains nearby...'); fetchPeaks(); }
  }, err => {
    setLoading('üìç','Location needed','Allow location in Settings ‚Üí Safari ‚Üí Location, then reload.');
  }, { enableHighAccuracy:true, timeout:20000, maximumAge:5000 });
}

// ‚îÄ‚îÄ FETCH PEAKS ‚îÄ‚îÄ
async function fetchPeaks() {
  try {
    const url = `https://secure.geonames.org/findNearbyJSON?lat=${userLat}&lng=${userLng}&featureClass=T&featureCode=PKS&featureCode=MT&featureCode=PK&featureCode=MTS&radius=150&maxRows=50&orderby=elevation&username=peakpeek_demo`;
    const data = await (await fetch(url)).json();
    if (data.geonames && data.geonames.length > 0) {
      peaks = data.geonames.filter(p=>p.elevation>500).map(p=>({
        name:p.name, lat:parseFloat(p.lat), lng:parseFloat(p.lng),
        elevation:p.elevation||0, country:p.countryCode||'', adminName:p.adminName1||'',
        distance:haversine(userLat,userLng,parseFloat(p.lat),parseFloat(p.lng)),
        bearing:calcBearing(userLat,userLng,parseFloat(p.lat),parseFloat(p.lng)),
      })).filter(p=>p.distance>0.5).sort((a,b)=>a.distance-b.distance).slice(0,30);
    } else { useFallback(); }
  } catch(e) { useFallback(); }

  document.getElementById('tray-peaks').textContent = peaks.length;
  document.getElementById('peaks-pill').textContent = peaks.length+' peaks nearby';
  setLoading('‚úÖ','Ready!','Point your phone at the horizon to see peaks.');
  setTimeout(hideOverlays, 1200);
  showStatus('‚õ∞Ô∏è '+peaks.length+' peaks found!', true);
}

function useFallback() {
  const d=[
    {name:'Monte Rosa',dlat:.8,dlng:.6,elev:4634},{name:'Matterhorn',dlat:.65,dlng:.4,elev:4478},
    {name:'Dom',dlat:.7,dlng:.5,elev:4545},{name:'Weisshorn',dlat:.6,dlng:.35,elev:4505},
    {name:'Dent Blanche',dlat:.55,dlng:.3,elev:4357},{name:'Mont Blanc',dlat:.5,dlng:-.5,elev:4808},
    {name:'Eiger',dlat:.45,dlng:.15,elev:3967},{name:'Jungfrau',dlat:.42,dlng:.12,elev:4158},
  ];
  peaks = d.map(p=>{ const lat=userLat+p.dlat, lng=userLng+p.dlng;
    return {name:p.name,lat,lng,elevation:p.elev,country:'CH',adminName:'Alps',
      distance:haversine(userLat,userLng,lat,lng), bearing:calcBearing(userLat,userLng,lat,lng)};
  });
}

// ‚îÄ‚îÄ ORIENTATION ‚îÄ‚îÄ
function handleOrientation(e) {
  if (e.webkitCompassHeading !== undefined) { heading = e.webkitCompassHeading; }
  else if (e.alpha !== null) { heading = (360 - e.alpha) % 360; }
  tiltX = -((e.beta||0) - 90);
  const cards=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  const idx = Math.round(heading/22.5)%16;
  document.getElementById('compass-dial').textContent    = cards[idx];
  document.getElementById('heading-display').textContent = Math.round(heading)+'¬∞';
  document.getElementById('tray-heading').textContent    = Math.round(heading)+'¬∞';
}

// ‚îÄ‚îÄ RENDER LOOP ‚îÄ‚îÄ
function startRenderLoop() { (function frame(){ renderAR(); requestAnimationFrame(frame); })(); }

function renderAR() {
  const c = document.getElementById('ar-container');
  const W = window.innerWidth, H = window.innerHeight;
  if (!peaks.length || userLat===null) { c.innerHTML=''; return; }
  const labels=[];
  peaks.forEach((peak,i)=>{
    let dB = peak.bearing - heading;
    dB = ((dB+540)%360)-180;
    if (Math.abs(dB) > H_FOV/2+8) return;
    const elevDiff = peak.elevation - Math.max(userAlt,100);
    const vAngle   = Math.atan2(elevDiff, peak.distance*1000)*(180/Math.PI);
    const dV       = vAngle - tiltX;
    if (Math.abs(dV) > V_FOV/2+18) return;
    const x = W/2 + (dB/(H_FOV/2))*(W/2);
    const y = H/2 - (dV/(V_FOV/2))*(H/2);
    if (x<-30||x>W+30) return;
    labels.push({peak, x, y:Math.max(90,Math.min(y,H-220)), i});
  });
  c.innerHTML='';
  if (!labels.length) { document.getElementById('no-peaks').classList.add('show'); return; }
  document.getElementById('no-peaks').classList.remove('show');
  labels.sort((a,b)=>a.peak.distance-b.peak.distance).forEach(({peak,x,y,i})=>{
    const dist = peak.distance<10 ? peak.distance.toFixed(1)+' km' : Math.round(peak.distance)+' km';
    const el = document.createElement('div');
    el.className='ar-label';
    el.style.cssText=`left:${x}px;top:${y-44}px;`;
    el.innerHTML=`<div class="ar-card" ontouchend="openDetail(${i})" onclick="openDetail(${i})"><div class="ar-name">${peak.name}</div><div class="ar-info">${peak.elevation.toLocaleString()} m ¬∑ ${dist}</div></div><div class="ar-stem"></div><div class="ar-dot"></div>`;
    c.appendChild(el);
  });
}

// ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ
function openDetail(i) {
  const p=peaks[i]; if(!p) return;
  const dist=p.distance<10?p.distance.toFixed(1)+' km':Math.round(p.distance)+' km';
  document.getElementById('dp-kicker').textContent=[p.country,p.adminName,dist].filter(Boolean).join(' ¬∑ ');
  document.getElementById('dp-title').textContent=p.name;
  document.getElementById('dp-alt').textContent='Elevation '+p.elevation.toLocaleString()+' m above sea level';
  document.getElementById('dp-elev').textContent=p.elevation.toLocaleString()+' m';
  document.getElementById('dp-dist').textContent=dist;
  document.getElementById('dp-bear').textContent=Math.round(p.bearing)+'¬∞';
  const btn=document.getElementById('dp-save');
  btn.textContent=savedPeaks.has(p.name)?'‚úì Saved':'Save Peak';
  btn.onclick=()=>{ savedPeaks.has(p.name)?savedPeaks.delete(p.name):savedPeaks.add(p.name); btn.textContent=savedPeaks.has(p.name)?'‚úì Saved':'Save Peak'; };
  document.getElementById('detail-panel').classList.add('open');
}
function closeDetail() { document.getElementById('detail-panel').classList.remove('open'); }
let ty0=0;
document.getElementById('detail-panel').addEventListener('touchstart',e=>ty0=e.touches[0].clientY,{passive:true});
document.getElementById('detail-panel').addEventListener('touchmove',e=>{ if(e.touches[0].clientY-ty0>60) closeDetail(); },{passive:true});
document.getElementById('video').addEventListener('click',closeDetail);

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function hideOverlays() { document.querySelectorAll('.overlay').forEach(o=>o.classList.add('hidden')); }
function setLoading(icon,title,body) {
  document.getElementById('loading-icon').textContent=icon;
  document.getElementById('loading-title').textContent=title;
  document.getElementById('loading-body').textContent=body;
}
let stTimer=null;
function showStatus(msg,autohide=false) {
  const el=document.getElementById('status');
  el.textContent=msg; el.classList.remove('hide');
  if(stTimer) clearTimeout(stTimer);
  if(autohide) stTimer=setTimeout(()=>el.classList.add('hide'),3500);
}
function haversine(lat1,lon1,lat2,lon2) {
  const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function calcBearing(lat1,lon1,lat2,lon2) {
  const dLon=(lon2-lon1)*Math.PI/180;
  const y=Math.sin(dLon)*Math.cos(lat2*Math.PI/180);
  const x=Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180)-Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLon);
  return((Math.atan2(y,x)*180/Math.PI)+360)%360;
}
</script>
</body>
</html>
