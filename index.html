<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PeakPeek</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --green: #1e4d30; --green-l: #2d6a4f; --green-50: #f0faf2; --green-100: #c8e6ce;
  --white: #fff; --bg: #f8f7f4; --ink: #1a1916; --ink-60: #5a5754; --ink-30: #a8a49c;
  --border: #ebe8e2;
  --safe-top: max(env(safe-area-inset-top), 44px);
  --safe-bot: max(env(safe-area-inset-bottom), 20px);
  --nav-h: 64px;
  --f: 'Plus Jakarta Sans', system-ui, sans-serif;
}
html, body { width:100%; height:100%; overflow:hidden; background:#111; font-family:var(--f); -webkit-font-smoothing:antialiased; user-select:none; -webkit-user-select:none; }

/* â”€â”€ VIDEO â”€â”€ */
#video { position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV â€” always on top
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 9999; /* highest possible */
  height: calc(var(--nav-h) + var(--safe-bot));
  display: flex;
  align-items: flex-start;
  justify-content: space-around;
  padding-top: 10px;
  /* default: transparent over camera */
  background: linear-gradient(0deg, rgba(0,0,0,0.72) 60%, transparent 100%);
  transition: background 0.25s;
}
#nav.light {
  background: var(--white);
  border-top: 1px solid var(--border);
  box-shadow: 0 -1px 0 var(--border);
}
.ni {
  display: flex; flex-direction: column; align-items: center; gap: 5px;
  padding: 4px 24px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  position: relative;
  z-index: 10000; /* above nav bg */
  pointer-events: auto;
}
.ni-icon { font-size: 22px; line-height: 1; }
.ni-lbl  { font-size: 10px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; }
/* dark nav (scan) */
#nav:not(.light) .ni-lbl            { color: rgba(255,255,255,0.4); }
#nav:not(.light) .ni.on .ni-lbl     { color: white; }
/* light nav (explore/me) */
#nav.light .ni-lbl                  { color: var(--ink-30); }
#nav.light .ni.on .ni-lbl           { color: var(--green); }
/* active dot */
.ni::after {
  content: '';
  position: absolute;
  bottom: -2px; left: 50%;
  transform: translateX(-50%);
  width: 4px; height: 4px; border-radius: 50%;
  opacity: 0; transition: opacity 0.2s;
}
#nav:not(.light) .ni.on::after { opacity: 1; background: white; }
#nav.light       .ni.on::after { opacity: 1; background: var(--green); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen {
  position: fixed; inset: 0;
  bottom: calc(var(--nav-h) + var(--safe-bot));
  z-index: 1;
  display: none;
  overflow: hidden;
}
.screen.active { display: block; }

/* SCAN â€” transparent, camera shows through */
#screen-scan { background: transparent; }

/* EXPLORE + ME â€” solid bg, scrollable */
#screen-explore,
#screen-me {
  background: var(--bg);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* â”€â”€ SCAN: TOP BAR â”€â”€ */
#scan-topbar {
  position: absolute; top: 0; left: 0; right: 0;
  padding: var(--safe-top) 20px 14px;
  display: flex; justify-content: space-between; align-items: center;
  background: linear-gradient(180deg, rgba(0,0,0,0.55) 0%, transparent 100%);
  z-index: 10;
  pointer-events: none;
}
.wordmark { font-size: 20px; font-weight: 800; letter-spacing: -0.04em; }
.wordmark.white { color: white; }
.wordmark.dark  { color: var(--ink); }
.wordmark span  { opacity: 0.4; }
.compass-wrap { display: flex; align-items: center; gap: 10px; pointer-events: auto; }
#heading-display { font-size: 13px; font-weight: 700; color: white; }
#compass-dial {
  width: 36px; height: 36px; border-radius: 50%;
  background: rgba(255,255,255,0.9);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 800; color: #c0392b;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

/* â”€â”€ SCAN: AR LABELS â”€â”€ */
#ar-container {
  position: absolute; inset: 0;
  z-index: 5;
  pointer-events: none; /* labels themselves enable pointer-events */
}
.ar-label {
  position: absolute;
  display: flex; flex-direction: column; align-items: center;
  transform: translateX(-50%);
  pointer-events: auto;
  cursor: pointer;
}
.ar-card {
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(20px) saturate(1.5);
  -webkit-backdrop-filter: blur(20px) saturate(1.5);
  border-radius: 10px; padding: 6px 12px 7px;
  box-shadow: 0 2px 16px rgba(0,0,0,0.2);
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
  active-transform: scale(0.94);
}
.ar-name { font-size: 11px; font-weight: 700; color: var(--ink); }
.ar-info { font-size: 9px; font-weight: 500; color: var(--green-l); margin-top: 1px; }
.ar-stem { width: 1px; height: 14px; background: linear-gradient(180deg, rgba(255,255,255,0.7), transparent); }
.ar-dot  { width: 6px; height: 6px; border-radius: 50%; background: white; box-shadow: 0 0 0 2px rgba(255,255,255,0.4); }

/* â”€â”€ SCAN: BOTTOM TRAY â”€â”€ */
#scan-tray {
  position: absolute; bottom: 0; left: 0; right: 0;
  padding: 20px 20px 16px;
  background: linear-gradient(0deg, rgba(0,0,0,0.65) 0%, transparent 100%);
  display: flex; align-items: flex-end;
  z-index: 6; pointer-events: none;
}
.ts { display: flex; flex-direction: column; gap: 2px; flex: 1; }
.tl { font-size: 8px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: rgba(255,255,255,0.45); }
.tv { font-size: 16px; font-weight: 700; letter-spacing: -0.02em; color: white; }
.td { width: 1px; height: 30px; background: rgba(255,255,255,0.2); margin: 0 16px 4px; }
#peaks-pill {
  background: var(--green); color: white; border-radius: 100px;
  padding: 7px 16px; font-size: 10px; font-weight: 700;
  margin-bottom: 2px; white-space: nowrap;
  box-shadow: 0 2px 12px rgba(30,77,48,0.5);
}

/* no peaks msg */
#no-peaks { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; z-index: 4; opacity: 0; transition: opacity 0.4s; pointer-events: none; }
#no-peaks.show { opacity: 1; }
#no-peaks p { font-size: 14px; color: rgba(255,255,255,0.75); font-weight: 500; line-height: 1.8; text-shadow: 0 1px 6px rgba(0,0,0,0.5); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPLORE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-topbar {
  position: sticky; top: 0; left: 0; right: 0;
  padding: var(--safe-top) 20px 14px;
  background: var(--white);
  border-bottom: 1px solid var(--border);
  z-index: 10;
  display: flex; justify-content: space-between; align-items: flex-end;
}
.page-title { font-size: 22px; font-weight: 800; letter-spacing: -0.04em; color: var(--ink); }
.page-sub   { font-size: 11px; color: var(--ink-30); font-weight: 500; }

.peak-list { display: flex; flex-direction: column; background: var(--white); }
.peak-row {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 20px; border-bottom: 1px solid var(--border);
  cursor: pointer; -webkit-tap-highlight-color: transparent;
  transition: background 0.1s;
  pointer-events: auto;
}
.peak-row:active { background: var(--bg); }
.pr-rank  { font-size: 11px; font-weight: 700; color: var(--ink-30); width: 20px; text-align: center; flex-shrink: 0; }
.pr-info  { flex: 1; min-width: 0; }
.pr-name  { font-size: 14px; font-weight: 700; color: var(--ink); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pr-where { font-size: 10px; color: var(--ink-60); margin-top: 2px; }
.pr-right { text-align: right; flex-shrink: 0; }
.pr-elev  { font-size: 13px; font-weight: 700; color: var(--green); }
.pr-dist  { font-size: 10px; color: var(--ink-30); margin-top: 2px; }
.pr-saved { font-size: 12px; margin-top: 2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.me-band {
  background: linear-gradient(150deg, #0f2a1a 0%, var(--green) 100%);
  padding: var(--safe-top) 22px 32px;
  position: relative; overflow: hidden;
}
.me-band-pattern {
  position: absolute; inset: 0; opacity: 0.05;
  background-image: radial-gradient(circle, white 1px, transparent 1px);
  background-size: 20px 20px;
}
.me-user { position: relative; z-index: 2; display: flex; align-items: center; gap: 14px; padding-top: 8px; }
.me-av {
  width: 54px; height: 54px; border-radius: 50%;
  background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.25);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; flex-shrink: 0;
}
.me-name  { font-size: 22px; font-weight: 800; letter-spacing: -0.03em; color: white; line-height: 1; }
.me-level { font-size: 10px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.45); margin-top: 4px; }

.me-stats { display: flex; gap: 10px; padding: 0 18px; margin-top: -24px; margin-bottom: 0; position: relative; z-index: 5; }
.me-stat {
  flex: 1; background: white; border: 1px solid var(--border);
  border-radius: 14px; padding: 14px 6px; text-align: center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
.ms-v { font-size: 28px; font-weight: 800; letter-spacing: -0.05em; color: var(--ink); line-height: 1; }
.ms-l { font-size: 8px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--ink-30); margin-top: 5px; }
.me-stat.hero .ms-v { color: var(--green); }

.me-section { padding: 24px 20px 0; }
.sec-hd { font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--ink-30); margin-bottom: 14px; }

.badges { display: flex; gap: 10px; }
.badge { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
.badge-icon {
  width: 52px; height: 52px; border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px;
}
.badge-icon.earned { background: var(--green-50); border: 1.5px solid var(--green-100); }
.badge-icon.locked { background: var(--bg); border: 1.5px solid var(--border); filter: grayscale(1); opacity: 0.4; }
.badge-lbl { font-size: 9px; font-weight: 600; color: var(--ink-60); text-align: center; line-height: 1.3; }

.saved-list { display: flex; flex-direction: column; gap: 8px; padding-bottom: 20px; }
.saved-row {
  display: flex; align-items: center; gap: 12px;
  padding: 13px 16px; background: white; border: 1px solid var(--border);
  border-radius: 14px; cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.saved-row:active { background: var(--green-50); }
.sr-emoji { font-size: 20px; flex-shrink: 0; }
.sr-info  { flex: 1; min-width: 0; }
.sr-name  { font-size: 14px; font-weight: 700; color: var(--ink); }
.sr-where { font-size: 10px; color: var(--ink-60); margin-top: 2px; }
.sr-elev  { font-size: 13px; font-weight: 700; color: var(--green); flex-shrink: 0; }

.empty-state { text-align: center; padding: 36px 20px; color: var(--ink-30); font-size: 13px; line-height: 1.7; }
.empty-icon  { font-size: 40px; margin-bottom: 10px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#detail-panel {
  position: fixed; bottom: -100%; left: 0; right: 0;
  background: white; border-radius: 24px 24px 0 0;
  padding: 20px 22px calc(var(--safe-bot) + 20px);
  z-index: 99999;
  box-shadow: 0 -8px 40px rgba(0,0,0,0.2);
  transition: bottom 0.36s cubic-bezier(0.32,0.72,0,1);
  max-height: 75vh; overflow-y: auto;
}
#detail-panel.open { bottom: 0; }
.dp-handle { width: 36px; height: 4px; background: #e0ddd8; border-radius: 2px; margin: 0 auto 18px; }
.dp-kicker { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--green-l); margin-bottom: 4px; }
.dp-title  { font-size: 34px; font-weight: 800; letter-spacing: -0.04em; color: var(--ink); line-height: 1; margin-bottom: 4px; }
.dp-sub    { font-size: 12px; color: var(--ink-30); margin-bottom: 18px; }
.dp-chips  { display: flex; gap: 8px; margin-bottom: 18px; }
.dp-chip   { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 10px 5px; text-align: center; }
.dc-v { font-size: 15px; font-weight: 700; color: var(--ink); }
.dc-l { font-size: 8px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--ink-30); margin-top: 3px; }
#dp-save {
  width: 100%; padding: 15px; border-radius: 100px;
  background: var(--green); color: white;
  border: none; font-family: var(--f); font-size: 14px; font-weight: 700;
  cursor: pointer; -webkit-tap-highlight-color: transparent;
  transition: opacity 0.15s, background 0.2s;
}
#dp-save:active { opacity: 0.8; }
#dp-save.saved { background: var(--green-50); color: var(--green); border: 1.5px solid var(--green-100); }
#dp-close {
  position: absolute; top: 18px; right: 18px;
  width: 30px; height: 30px; border-radius: 50%;
  background: var(--bg); border: none;
  cursor: pointer; font-size: 14px; color: var(--ink-30);
  display: flex; align-items: center; justify-content: center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATUS + TOAST + HINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#status {
  position: fixed; top: calc(var(--safe-top) + 52px);
  left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
  color: rgba(255,255,255,0.9); border-radius: 100px;
  padding: 7px 16px; font-size: 11px; font-weight: 600;
  z-index: 1000; transition: opacity 0.4s; white-space: nowrap; pointer-events: none;
}
#status.hide { opacity: 0; }

#toast {
  position: fixed; top: calc(var(--safe-top) + 52px);
  left: 50%; transform: translateX(-50%) translateY(-6px);
  background: var(--green); color: white; border-radius: 100px;
  padding: 9px 20px; font-size: 12px; font-weight: 700;
  white-space: nowrap; z-index: 99998;
  opacity: 0; transition: opacity 0.25s, transform 0.25s; pointer-events: none;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

#cal-hint {
  position: fixed; bottom: calc(var(--nav-h) + var(--safe-bot) + 100px);
  left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
  border-radius: 12px; padding: 10px 16px;
  font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.85);
  z-index: 20; text-align: center; max-width: 220px; line-height: 1.5;
  opacity: 0; transition: opacity 0.4s; pointer-events: none;
}
#cal-hint.show { opacity: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAYS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay {
  position: fixed; inset: 0; z-index: 99990;
  background: linear-gradient(160deg, #0d2b1a 0%, #1e4d30 100%);
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 40px 32px; text-align: center;
  transition: opacity 0.4s;
}
.overlay.hidden { opacity: 0; pointer-events: none; }
.ov-logo    { font-size: 26px; font-weight: 800; letter-spacing: -0.04em; color: white; margin-bottom: 4px; }
.ov-logo span { color: rgba(255,255,255,0.35); }
.ov-tagline { font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 40px; letter-spacing: 0.04em; }
.ov-icon    { font-size: 52px; margin-bottom: 18px; }
.ov-title   { font-size: 24px; font-weight: 800; letter-spacing: -0.03em; color: white; margin-bottom: 10px; line-height: 1.1; }
.ov-body    { font-size: 14px; color: rgba(255,255,255,0.5); line-height: 1.65; margin-bottom: 28px; max-width: 280px; }
.perm-steps { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; width: 100%; max-width: 280px; }
.perm-step  { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 14px; }
.perm-icon  { font-size: 20px; flex-shrink: 0; }
.perm-name  { font-size: 12px; font-weight: 700; color: white; }
.perm-desc  { font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 2px; }
.perm-check { font-size: 16px; flex-shrink: 0; opacity: 0; transition: opacity 0.3s; margin-left: auto; }
.perm-check.done { opacity: 1; }
.ov-btn { width: 100%; max-width: 280px; padding: 16px; background: white; color: var(--green); border: none; border-radius: 100px; font-family: var(--f); font-size: 15px; font-weight: 800; cursor: pointer; box-shadow: 0 8px 24px rgba(0,0,0,0.3); transition: transform 0.15s, opacity 0.15s; -webkit-tap-highlight-color: transparent; margin-bottom: 10px; }
.ov-btn:active { transform: scale(0.97); opacity: 0.9; }
.ov-btn:disabled { opacity: 0.5; }
.ov-note { font-size: 11px; color: rgba(255,255,255,0.25); max-width: 260px; line-height: 1.5; }
</style>
</head>
<body>

<!-- VIDEO (always behind everything) -->
<video id="video" autoplay playsinline muted style="display:none;"></video>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCAN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-scan">
  <div id="scan-topbar">
    <div class="wordmark white">Peak<span>Peek</span></div>
    <div class="compass-wrap">
      <div id="heading-display">--Â°</div>
      <div id="compass-dial">N</div>
    </div>
  </div>

  <div id="ar-container"></div>

  <div id="no-peaks">
    <p>â›°ï¸<br>Point toward the horizon<br>to find peaks</p>
  </div>

  <div id="scan-tray">
    <div class="ts"><div class="tl">Altitude</div><div class="tv" id="tray-alt">-- m</div></div>
    <div class="td"></div>
    <div class="ts"><div class="tl">Heading</div><div class="tv" id="tray-heading">--Â°</div></div>
    <div class="td"></div>
    <div class="ts"><div class="tl">Peaks</div><div class="tv" id="tray-peaks">--</div></div>
    <div id="peaks-pill">Loading...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EXPLORE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-explore">
  <div class="page-topbar">
    <div>
      <div class="page-title">Nearby Peaks</div>
    </div>
    <div class="page-sub" id="explore-count">--</div>
  </div>
  <div class="peak-list" id="peak-list">
    <div class="empty-state"><div class="empty-icon">ğŸ“¡</div>Waiting for location...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-me">
  <div class="me-band">
    <div class="me-band-pattern"></div>
    <div class="me-user">
      <div class="me-av">ğŸ§—</div>
      <div>
        <div class="me-name">Explorer</div>
        <div class="me-level">PeakPeek Â· <span id="me-level-txt">Level 1</span></div>
      </div>
    </div>
  </div>
  <div class="me-stats">
    <div class="me-stat hero"><div class="ms-v" id="me-scanned">0</div><div class="ms-l">Scanned</div></div>
    <div class="me-stat"><div class="ms-v" id="me-saved-count">0</div><div class="ms-l">Saved</div></div>
    <div class="me-stat"><div class="ms-v" id="me-countries">--</div><div class="ms-l">Nearest</div></div>
  </div>
  <div class="me-section">
    <div class="sec-hd">Badges</div>
    <div class="badges">
      <div class="badge"><div class="badge-icon earned" id="b-first">â›°ï¸</div><div class="badge-lbl">First Peek</div></div>
      <div class="badge"><div class="badge-icon locked" id="b-5">ğŸ”­</div><div class="badge-lbl">5 Saved</div></div>
      <div class="badge"><div class="badge-icon locked" id="b-4k">ğŸ”ï¸</div><div class="badge-lbl">4000er</div></div>
      <div class="badge"><div class="badge-icon locked" id="b-10">ğŸŒ</div><div class="badge-lbl">10 Saved</div></div>
    </div>
  </div>
  <div class="me-section" style="padding-bottom:24px;">
    <div class="sec-hd">Saved Peaks</div>
    <div class="saved-list" id="saved-list">
      <div class="empty-state">
        <div class="empty-icon">ğŸ”ï¸</div>
        Scan a peak and tap<br><strong>Save</strong> to build your collection
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="nav">
  <div class="ni on" id="ni-scan"    onclick="switchTab('scan')">
    <div class="ni-icon">â›°</div><div class="ni-lbl">Scan</div>
  </div>
  <div class="ni" id="ni-explore" onclick="switchTab('explore')">
    <div class="ni-icon">ğŸ”</div><div class="ni-lbl">Explore</div>
  </div>
  <div class="ni" id="ni-me" onclick="switchTab('me')">
    <div class="ni-icon">â—</div><div class="ni-lbl">Me</div>
  </div>
</div>

<!-- STATUS + TOAST + HINT -->
<div id="status" class="hide"></div>
<div id="toast"></div>
<div id="cal-hint">ğŸ§­ Move phone in a figure-8 to calibrate compass</div>

<!-- DETAIL PANEL -->
<div id="detail-panel">
  <div class="dp-handle"></div>
  <button id="dp-close" onclick="closeDetail()">âœ•</button>
  <div class="dp-kicker" id="dp-kicker"></div>
  <div class="dp-title"  id="dp-title">â€”</div>
  <div class="dp-sub"    id="dp-sub"></div>
  <div class="dp-chips">
    <div class="dp-chip"><div class="dc-v" id="dp-elev">â€”</div><div class="dc-l">Elevation</div></div>
    <div class="dp-chip"><div class="dc-v" id="dp-dist">â€”</div><div class="dc-l">Distance</div></div>
    <div class="dp-chip"><div class="dc-v" id="dp-bear">â€”</div><div class="dc-l">Bearing</div></div>
  </div>
  <button id="dp-save" onclick="toggleSave()">Save Peak â™¡</button>
</div>

<!-- SPLASH -->
<div class="overlay" id="step-splash">
  <div class="ov-logo">Peak<span>Peek</span></div>
  <div class="ov-tagline">Know every mountain by name</div>
  <div class="ov-icon">â›°ï¸</div>
  <div class="ov-title">Real AR.<br>Real mountains.</div>
  <div class="ov-body">Point your phone at any mountain and instantly see its name, elevation and distance.</div>
  <button class="ov-btn" id="btn-start">Get Started â†’</button>
  <div class="ov-note">Works best outdoors pointing at the horizon</div>
</div>

<!-- PERMISSIONS -->
<div class="overlay hidden" id="step-perms">
  <div class="ov-logo">Peak<span>Peek</span></div>
  <div class="ov-tagline">One-time setup</div>
  <div class="ov-icon">ğŸ”</div>
  <div class="ov-title">3 quick<br>permissions</div>
  <div class="ov-body">Tap below â€” iOS will ask you to confirm each one.</div>
  <div class="perm-steps">
    <div class="perm-step"><div class="perm-icon">ğŸ“·</div><div><div class="perm-name">Camera</div><div class="perm-desc">See mountains through your lens</div></div><div class="perm-check" id="pc-cam">âœ…</div></div>
    <div class="perm-step"><div class="perm-icon">ğŸ“</div><div><div class="perm-name">Location</div><div class="perm-desc">Find peaks near you</div></div><div class="perm-check" id="pc-loc">âœ…</div></div>
    <div class="perm-step"><div class="perm-icon">ğŸ§­</div><div><div class="perm-name">Motion & Compass</div><div class="perm-desc">Know which direction you're pointing</div></div><div class="perm-check" id="pc-mot">âœ…</div></div>
  </div>
  <button class="ov-btn" id="btn-perms">Allow & Start â†’</button>
  <div class="ov-note">All data stays on your device.</div>
</div>

<!-- LOADING -->
<div class="overlay hidden" id="step-loading">
  <div class="ov-logo">Peak<span>Peek</span></div>
  <div class="ov-tagline">Almost there...</div>
  <div class="ov-icon" id="li">ğŸ—ºï¸</div>
  <div class="ov-title" id="lt">Finding your<br>location...</div>
  <div class="ov-body"  id="lb">Locking onto GPS and fetching peaks near you.</div>
</div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let userLat=null, userLng=null, userAlt=0;
let heading=0, tiltX=0, prevH=null;
let peaks=[], savedPeaks=new Set();
let currentTab='scan', detailIdx=null;
const H_FOV=60, V_FOV=45;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('on'));
  document.getElementById('screen-'+tab).classList.add('active');
  document.getElementById('ni-'+tab).classList.add('on');
  const nav=document.getElementById('nav');
  const vid=document.getElementById('video');
  if (tab==='scan') {
    nav.classList.remove('light');
    vid.style.display='block';
  } else {
    nav.classList.add('light');
    vid.style.display='none';
    closeDetail();
  }
  currentTab=tab;
  if (tab==='explore') renderExplore();
  if (tab==='me')      renderMe();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERLAYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-start').addEventListener('click', ()=>{
  hide('step-splash'); show('step-perms');
});

document.getElementById('btn-perms').addEventListener('click', async function() {
  this.disabled=true; this.textContent='Setting up...';

  // 1. Camera â€” must be first user gesture
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    const v=document.getElementById('video');
    v.srcObject=stream; v.style.display='block';
    await v.play();
    done('pc-cam');
  } catch(e) {
    alert('Camera denied. Go to Settings â†’ Safari â†’ Camera â†’ Allow, then reload.');
    this.disabled=false; this.textContent='Allow & Start â†’'; return;
  }

  // 2. Motion â€” iOS 13+ needs direct user gesture
  if (typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function') {
    try {
      if (await DeviceOrientationEvent.requestPermission()==='granted') {
        window.addEventListener('deviceorientation', onOrient, true);
        done('pc-mot');
      }
    } catch(e){}
  } else {
    window.addEventListener('deviceorientation', onOrient, true);
    done('pc-mot');
  }

  // 3. GPS + loading screen
  hide('step-perms'); show('step-loading');
  startGPS();
  startLoop();

  setTimeout(()=>{ const h=document.getElementById('cal-hint'); h.classList.add('show'); setTimeout(()=>h.classList.remove('show'),4500); }, 8000);
});

function hide(id){ document.getElementById(id).classList.add('hidden'); }
function show(id){ document.getElementById(id).classList.remove('hidden'); }
function done(id){ document.getElementById(id).classList.add('done'); }
function setLoad(i,t,b){ document.getElementById('li').textContent=i; document.getElementById('lt').textContent=t; document.getElementById('lb').textContent=b; }
function hideOverlays(){ document.querySelectorAll('.overlay').forEach(o=>o.classList.add('hidden')); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGPS() {
  if (!navigator.geolocation) { setLoad('âš ï¸','No GPS','Device does not support location.'); setTimeout(hideOverlays,2000); return; }
  navigator.geolocation.watchPosition(pos=>{
    const first=userLat===null;
    userLat=pos.coords.latitude; userLng=pos.coords.longitude; userAlt=pos.coords.altitude||0;
    done('pc-loc');
    document.getElementById('tray-alt').textContent=userAlt>0?Math.round(userAlt)+' m':'-- m';
    if (first){ setLoad('â›°ï¸','Loading peaks...','Found you! Fetching mountains nearby...'); fetchPeaks(); }
  }, ()=>setLoad('ğŸ“','Location needed','Allow location in Settings â†’ Safari â†’ Location'),
  {enableHighAccuracy:true,timeout:20000,maximumAge:5000});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH PEAKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPeaks() {
  try {
    const url=`https://secure.geonames.org/findNearbyJSON?lat=${userLat}&lng=${userLng}&featureClass=T&featureCode=PKS&featureCode=MT&featureCode=PK&featureCode=MTS&radius=150&maxRows=50&orderby=elevation&username=peakpeek_demo`;
    const d=await (await fetch(url)).json();
    if (d.geonames&&d.geonames.length>0) buildPeaks(d.geonames); else useFallback();
  } catch(e){ useFallback(); }
  finishLoad();
}

function buildPeaks(g) {
  peaks=g.filter(p=>p.elevation>100).map(p=>({
    name:p.name, lat:parseFloat(p.lat), lng:parseFloat(p.lng),
    elevation:p.elevation||0, country:p.countryCode||'', admin:p.adminName1||'',
    distance:haversine(userLat,userLng,parseFloat(p.lat),parseFloat(p.lng)),
    bearing:calcBearing(userLat,userLng,parseFloat(p.lat),parseFloat(p.lng)),
  })).filter(p=>p.distance>0.1).sort((a,b)=>a.distance-b.distance).slice(0,40);
}

function useFallback() {
  const d=[
    {n:'Monte Rosa',dlat:.8,dlng:.6,e:4634,c:'CH'},{n:'Matterhorn',dlat:.65,dlng:.4,e:4478,c:'CH'},
    {n:'Dom',dlat:.7,dlng:.5,e:4545,c:'CH'},{n:'Weisshorn',dlat:.6,dlng:.35,e:4505,c:'CH'},
    {n:'Dent Blanche',dlat:.55,dlng:.3,e:4357,c:'CH'},{n:'Mont Blanc',dlat:.5,dlng:-.5,e:4808,c:'FR'},
    {n:'Eiger',dlat:.45,dlng:.15,e:3967,c:'CH'},{n:'Jungfrau',dlat:.42,dlng:.12,e:4158,c:'CH'},
  ];
  peaks=d.map(p=>{const lat=userLat+p.dlat,lng=userLng+p.dlng; return {name:p.n,lat,lng,elevation:p.e,country:p.c,admin:'Alps',distance:haversine(userLat,userLng,lat,lng),bearing:calcBearing(userLat,userLng,lat,lng)};});
}

function finishLoad() {
  document.getElementById('tray-peaks').textContent=peaks.length;
  document.getElementById('peaks-pill').textContent=peaks.length+' peaks nearby';
  setLoad('âœ…','Ready!','Point at the horizon to see peaks.');
  setTimeout(hideOverlays,1000);
  showStatus('â›°ï¸ '+peaks.length+' peaks found!',true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORIENTATION â€” smoothed heading
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onOrient(e) {
  let raw;
  if (e.webkitCompassHeading!==undefined) raw=e.webkitCompassHeading;
  else if (e.alpha!==null) raw=(360-e.alpha)%360;
  else return;

  // Smooth with lerp, handling 0/360 wrap
  if (prevH===null) prevH=raw;
  let diff=raw-prevH;
  if (diff>180) diff-=360;
  if (diff<-180) diff+=360;
  prevH=(prevH+diff*0.3+360)%360;
  heading=prevH;

  // Tilt
  tiltX=-((e.beta||0)-90);

  // Update compass UI
  const cards=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  const idx=Math.round(heading/22.5)%16;
  document.getElementById('compass-dial').textContent=cards[idx];
  document.getElementById('heading-display').textContent=Math.round(heading)+'Â°';
  document.getElementById('tray-heading').textContent=Math.round(heading)+'Â°';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startLoop() { (function f(){ if(currentTab==='scan') renderAR(); requestAnimationFrame(f); })(); }

function renderAR() {
  const c=document.getElementById('ar-container');
  const W=window.innerWidth, H=window.innerHeight;
  if (!peaks.length||userLat===null){ c.innerHTML=''; return; }

  const labels=[];
  peaks.forEach((p,i)=>{
    let dB=p.bearing-heading;
    dB=((dB+540)%360)-180;
    if (Math.abs(dB)>H_FOV/2+10) return;
    const vA=Math.atan2(p.elevation-Math.max(userAlt,5),p.distance*1000)*(180/Math.PI);
    const dV=vA-tiltX;
    if (Math.abs(dV)>V_FOV/2+20) return;
    const x=W/2+(dB/(H_FOV/2))*(W/2);
    const y=H/2-(dV/(V_FOV/2))*(H/2);
    if (x<-50||x>W+50) return;
    labels.push({p,x,y:Math.max(80,Math.min(y,H-180)),i});
  });

  c.innerHTML='';
  if (!labels.length){ document.getElementById('no-peaks').classList.add('show'); return; }
  document.getElementById('no-peaks').classList.remove('show');

  labels.sort((a,b)=>a.p.distance-b.p.distance).forEach(({p,x,y,i})=>{
    const el=document.createElement('div');
    el.className='ar-label';
    el.style.cssText=`left:${x}px;top:${y-42}px;`;
    el.innerHTML=`<div class="ar-card" ontouchend="openDetail(${i})" onclick="openDetail(${i})"><div class="ar-name">${p.name}</div><div class="ar-info">${p.elevation.toLocaleString()} m Â· ${fd(p.distance)}</div></div><div class="ar-stem"></div><div class="ar-dot"></div>`;
    c.appendChild(el);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPLORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderExplore() {
  const list=document.getElementById('peak-list');
  const ct=document.getElementById('explore-count');
  if (!peaks.length){ list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“¡</div>Loading peaks...</div>'; return; }
  ct.textContent=peaks.length+' peaks within 150 km';
  list.innerHTML=peaks.map((p,i)=>`
    <div class="peak-row" onclick="openDetail(${i})">
      <div class="pr-rank">${i+1}</div>
      <div class="pr-info">
        <div class="pr-name">${p.name}</div>
        <div class="pr-where">${[p.country,p.admin].filter(Boolean).join(' Â· ')}</div>
      </div>
      <div class="pr-right">
        <div class="pr-elev">${p.elevation.toLocaleString()} m</div>
        <div class="pr-dist">${fd(p.distance)}</div>
        <div class="pr-saved">${savedPeaks.has(p.name)?'â™¥':''}</div>
      </div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMe() {
  const n=savedPeaks.size;
  document.getElementById('me-saved-count').textContent=n;
  document.getElementById('me-scanned').textContent=peaks.length||0;
  const nearest=peaks.length?peaks[0].name.slice(0,3)+'..':'--';
  document.getElementById('me-countries').textContent=peaks.length?fd(peaks[0].distance):'--';
  document.getElementById('me-level-txt').textContent='Level '+(Math.floor(n/3)+1);

  // Badges
  const b5=document.getElementById('b-5'), b4k=document.getElementById('b-4k'), b10=document.getElementById('b-10');
  if(n>=5){b5.classList.replace('locked','earned');}
  if(n>=10){b10.classList.replace('locked','earned');}
  if([...savedPeaks].some(name=>{const p=peaks.find(p=>p.name===name);return p&&p.elevation>=4000;})){b4k.classList.replace('locked','earned');}

  // Saved list
  const sl=document.getElementById('saved-list');
  if (n===0){
    sl.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ”ï¸</div>Scan a peak and tap <strong>Save</strong><br>to build your collection</div>';
    return;
  }
  sl.innerHTML=[...savedPeaks].map(name=>{
    const p=peaks.find(p=>p.name===name);
    return `<div class="saved-row" onclick="openDetail(${peaks.indexOf(p)})">
      <div class="sr-emoji">â›°ï¸</div>
      <div class="sr-info"><div class="sr-name">${name}</div><div class="sr-where">${p?[p.country,p.admin].filter(Boolean).join(' Â· '):''}</div></div>
      <div class="sr-elev">${p?p.elevation.toLocaleString()+' m':''}</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(i) {
  const p=peaks[i]; if(!p) return;
  detailIdx=i;
  document.getElementById('dp-kicker').textContent=[p.country,p.admin,fd(p.distance)].filter(Boolean).join(' Â· ');
  document.getElementById('dp-title').textContent=p.name;
  document.getElementById('dp-sub').textContent=p.elevation.toLocaleString()+' m above sea level';
  document.getElementById('dp-elev').textContent=p.elevation.toLocaleString()+' m';
  document.getElementById('dp-dist').textContent=fd(p.distance);
  document.getElementById('dp-bear').textContent=Math.round(p.bearing)+'Â°';
  updateSaveBtn(p.name);
  document.getElementById('detail-panel').classList.add('open');
}

function updateSaveBtn(name) {
  const btn=document.getElementById('dp-save');
  if (savedPeaks.has(name)){ btn.textContent='âœ“ Saved'; btn.classList.add('saved'); }
  else { btn.textContent='Save Peak â™¡'; btn.classList.remove('saved'); }
}

function toggleSave() {
  if (detailIdx===null) return;
  const p=peaks[detailIdx]; if(!p) return;
  if (savedPeaks.has(p.name)){ savedPeaks.delete(p.name); toast('Removed from saved'); }
  else { savedPeaks.add(p.name); toast('â›°ï¸ '+p.name+' saved!'); }
  updateSaveBtn(p.name);
  if (currentTab==='me') renderMe();
  if (currentTab==='explore') renderExplore();
}

function closeDetail(){ document.getElementById('detail-panel').classList.remove('open'); detailIdx=null; }

// Swipe down to close
let ty0=0;
document.getElementById('detail-panel').addEventListener('touchstart',e=>{ty0=e.touches[0].clientY;},{passive:true});
document.getElementById('detail-panel').addEventListener('touchmove',e=>{if(e.touches[0].clientY-ty0>70)closeDetail();},{passive:true});
document.getElementById('video').addEventListener('click',closeDetail);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS / TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let stT=null;
function showStatus(msg,hide=false){
  const el=document.getElementById('status');
  el.textContent=msg; el.classList.remove('hide');
  if(stT)clearTimeout(stT);
  if(hide)stT=setTimeout(()=>el.classList.add('hide'),3500);
}

let toT=null;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('show');
  if(toT)clearTimeout(toT);
  toT=setTimeout(()=>el.classList.remove('show'),2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fd(d){ return d<10?d.toFixed(1)+' km':Math.round(d)+' km'; }
function haversine(a,b,c,d){const R=6371,dL=(c-a)*Math.PI/180,dO=(d-b)*Math.PI/180,x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dO/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}
function calcBearing(a,b,c,d){const dO=(d-b)*Math.PI/180,y=Math.sin(dO)*Math.cos(c*Math.PI/180),x=Math.cos(a*Math.PI/180)*Math.sin(c*Math.PI/180)-Math.sin(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.cos(dO);return((Math.atan2(y,x)*180/Math.PI)+360)%360;}
</script>
</body>
</html>
